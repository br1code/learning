# Code first & Migrations

Code First is an approach in Entity Framework Core (EF Core) that allows you to create and maintain the database schema based on your .NET model classes. With Code First, you define your model using C# classes, and EF Core generates the corresponding database schema and tables. As your model evolves, you can create and apply migrations to keep your database schema in sync with your model.

Migrations are a set of commands generated by EF Core to evolve the database schema to match the changes in your model. Migrations allow you to apply incremental changes to the database, preserving existing data while keeping the schema up-to-date.

Here's a step-by-step example of using Code First and Migrations:

1. Define your model classes:

```csharp
public class Blog
{
    public int BlogId { get; set; }
    public string Url { get; set; }

    public List<Post> Posts { get; set; }
}

public class Post
{
    public int PostId { get; set; }
    public string Title { get; set; }
    public string Content { get; set; }

    public int BlogId { get; set; }
    public Blog Blog { get; set; }
}
```

2. Create a DbContext:

```csharp
public class BloggingContext : DbContext
{
    public DbSet<Blog> Blogs { get; set; }
    public DbSet<Post> Posts { get; set; }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        optionsBuilder.UseSqlServer("Server=(localdb)\\mssqllocaldb;Database=Blogging;Trusted_Connection=True;");
    }
}
```

3. Install the necessary NuGet packages for migrations:

```
Install-Package Microsoft.EntityFrameworkCore.Tools
```

4. Add an initial migration:


In Package Manager Console, run:

```
Add-Migration InitialCreate
```

This command generates a migration file with the schema changes required to create the database based on your model.

5. Apply the migration to the database:

In Package Manager Console, run:

```
Update-Database
```

This command applies the migration to the database, creating the schema and tables as defined in your model.

6. Update your model:

For example, add a new property "Author" to the Post class:

```csharp
public class Post
{
    // ...
    public string Author { get; set; }
}
```

7. Create a new migration for the updated model:

In Package Manager Console, run:

```
Add-Migration AddAuthorToPost
```

This command generates a new migration file with the schema changes required to update the database based on the modified model.

8. Apply the new migration to the database:

In Package Manager Console, run:

```
Update-Database
```

This command applies the new migration to the database, updating the schema to match the changes in your model.

In summary, the Code First approach in EF Core allows you to create and maintain the database schema based on your .NET model classes. Migrations enable you to apply incremental changes to the database as your model evolves, keeping the schema in sync with your application's requirements.

## Migrations in depth

A migration file in Entity Framework Core (EF Core) is a C# class that contains the schema changes required to evolve the database schema to match the updated model. When you run the `Add-Migration` command, EF Core generates a migration file containing two primary methods: `Up(MigrationBuilder migrationBuilder)` and `Down(MigrationBuilder migrationBuilder)`.

The `Up` method contains the schema changes that need to be applied to the database, while the `Down` method contains the reverse operations to revert the changes applied by the `Up` method. This allows you to move forward and backward between different versions of your database schema.

Here's an example of a migration file generated by EF Core when adding an "Author" column to the "Post" table:

```csharp
public partial class AddAuthorToPost : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.AddColumn<string>(
            name: "Author",
            table: "Posts",
            type: "nvarchar(max)",
            nullable: true);
    }

    protected override void Down(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.DropColumn(
            name: "Author",
            table: "Posts");
    }
}
```

In this example, the `Up` method adds a new "Author" column to the "Posts" table, and the `Down` method drops the "Author" column.

When you run the `Update-Database` command, EF Core applies the migrations to the database in the following steps:

1. Checks the current state of the database schema: EF Core looks at the `__EFMigrationsHistory` table in the database, which stores a record for each migration that has been applied. If this table doesn't exist, EF Core creates it.

2. Identifies the pending migrations: EF Core compares the migrations in the `__EFMigrationsHistory` table with the migration files in your project to determine which migrations haven't been applied yet.

3. Executes the `Up` methods of the pending migrations: EF Core applies the pending migrations in the order they were added, executing the `Up` method of each migration. It uses the `MigrationBuilder` parameter to generate the appropriate SQL statements for the specified database provider (e.g., SQL Server, PostgreSQL, etc.).

4. Records the applied migrations: After each migration is applied, EF Core adds a new record to the `__EFMigrationsHistory` table, indicating that the migration has been applied to the database.

If you need to revert a migration, you can use the `Update-Database` command with the `-TargetMigration` parameter, specifying the target migration to revert to. EF Core will then execute the `Down` methods of the migrations in reverse order to revert the schema changes.

For example, to revert the last applied migration, you can run:

```
Update-Database -TargetMigration PreviousMigrationName
```

In summary, migration files in EF Core define the schema changes that need to be applied to the database, with `Up` methods to apply changes and `Down` methods to revert them. When you run the `Update-Database` command, EF Core identifies the pending migrations, executes the `Up` methods, and records the applied migrations in the `__EFMigrationsHistory` table.